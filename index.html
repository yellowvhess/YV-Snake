<script>
    // Глобальные переменные
    let isDarkTheme = false;
    let isEnglish = false;
    let winnersCount = 0;

    // Элементы DOM
    const mainMenu = document.getElementById('main-menu');
    const gameContainer = document.getElementById('game-container');
    const gameCanvas = document.getElementById('game-canvas');
    const ctx = gameCanvas.getContext('2d');
    const scoreDisplay = document.getElementById('score-display');
    const settingsModal = document.getElementById('settings-modal');
    const gameOverModal = document.getElementById('game-over-modal');
    const winModal = document.getElementById('win-modal');
    const winnersCountSpan = document.getElementById('winners-count');
    
    // Кнопки
    const playButton = document.getElementById('play-button');
    const settingsButton = document.getElementById('settings-button');
    const exitButton = document.getElementById('exit-button');
    const closeSettings = document.getElementById('close-settings');
    const themeSwitch = document.getElementById('theme-switch');
    const languageSwitch = document.getElementById('language-switch');
    const restartButton = document.getElementById('restart-button');
    const homeButton = document.getElementById('home-button');
    const winHomeButton = document.getElementById('win-home-button');
    const telegramIcon = document.getElementById('telegram-icon');
    const helpButton = document.getElementById('help-button');
    const helpModal = document.getElementById('help-modal');
    
    // Мобильные кнопки управления
    const upBtn = document.getElementById('up-btn');
    const leftBtn = document.getElementById('left-btn');
    const rightBtn = document.getElementById('right-btn');
    const downBtn = document.getElementById('down-btn');

    // Игровые переменные
    let snake = [];
    let food = {};
    let direction = 'right';
    let nextDirection = 'right';
    let gameInterval;
    let score = 0;
    let scoreInterval;
    let gameStarted = false;
    let canChangeDirection = true;

    // Инициализация игры
    function initGame() {
        // Сброс змейки
        snake = [
            {x: 200, y: 200},
            {x: 190, y: 200},
            {x: 180, y: 200},
            {x: 170, y: 200},
            {x: 160, y: 200}
        ];
        
        direction = 'right';
        nextDirection = 'right';
        score = 0;
        updateScoreDisplay();
        
        // Создание еды
        createFood();
        
        // Очистка canvas
        ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
        
        // Отрисовка змейки и еды
        drawSnake();
        drawFood();
        
        // Запуск игрового цикла
        if (gameInterval) clearInterval(gameInterval);
        if (scoreInterval) clearInterval(scoreInterval);
        
        gameInterval = setInterval(gameLoop, 100);
        scoreInterval = setInterval(incrementScore, 1000);
        gameStarted = false;
        canChangeDirection = true;
    }

    // Игровой цикл
    function gameLoop() {
        if (!gameStarted) return;
        
        // Разрешаем изменение направления перед следующим шагом
        canChangeDirection = true;
        
        // Обновление направления
        direction = nextDirection;
        
        // Получение головы змейки
        const head = {x: snake[0].x, y: snake[0].y};
        
        // Перемещение головы в зависимости от направления
        switch (direction) {
            case 'up':
                head.y -= 10;
                break;
            case 'down':
                head.y += 10;
                break;
            case 'left':
                head.x -= 10;
                break;
            case 'right':
                head.x += 10;
                break;
        }
        
        // Проверка на столкновение с границами
        if (head.x < 0 || head.x >= gameCanvas.width || head.y < 0 || head.y >= gameCanvas.height) {
            gameOver();
            return;
        }
        
        // Проверка на столкновение с собой
        for (let i = 0; i < snake.length; i++) {
            if (head.x === snake[i].x && head.y === snake[i].y) {
                gameOver();
                return;
            }
        }
        
        // Добавление новой головы
        snake.unshift(head);
        
        // Проверка на съедание еды
        if (head.x === food.x && head.y === food.y) {
            // Увеличение счета
            score += 10;
            updateScoreDisplay();
            
            // Создание новой еды
            createFood();
            
            // Проверка на победу
            if (score >= 1000) {
                winGame();
                return;
            }
        } else {
            // Удаление хвоста, если еда не съедена
            snake.pop();
        }
        
        // Отрисовка игры
        ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
        drawSnake();
        drawFood();
    }

    // Отрисовка змейки
    function drawSnake() {
        ctx.fillStyle = '#4CAF50';
        for (let i = 0; i < snake.length; i++) {
            ctx.fillRect(snake[i].x, snake[i].y, 10, 10);
            
            // Добавление границ для сегментов змейки
            ctx.strokeStyle = '#45a049';
            ctx.strokeRect(snake[i].x, snake[i].y, 10, 10);
        }
    }

    // Создание еды
    function createFood() {
        food = {
            x: Math.floor(Math.random() * (gameCanvas.width / 10)) * 10,
            y: Math.floor(Math.random() * (gameCanvas.height / 10)) * 10
        };
        
        // Проверка, чтобы еда не появилась на змейке
        for (let i = 0; i < snake.length; i++) {
            if (food.x === snake[i].x && food.y === snake[i].y) {
                createFood();
                return;
            }
        }
    }

    // Отрисовка еды
    function drawFood() {
        ctx.fillStyle = 'red';
        ctx.fillRect(food.x, food.y, 10, 10);
        
        // Добавление границ для еды
        ctx.strokeStyle = 'darkred';
        ctx.strokeRect(food.x, food.y, 10, 10);
    }

    // Обновление счета
    function updateScoreDisplay() {
        scoreDisplay.textContent = isEnglish ? `Score: ${score}` : `Очки: ${score}`;
    }

    // Увеличение счета каждую секунду
    function incrementScore() {
        if (gameStarted) {
            score += 10;
            updateScoreDisplay();
            
            if (score >= 1000) {
                winGame();
            }
        }
    }

    // Конец игры
    function gameOver() {
        clearInterval(gameInterval);
        clearInterval(scoreInterval);
        gameOverModal.style.display = 'flex';
    }

    // Победа в игре
    function winGame() {
        clearInterval(gameInterval);
        clearInterval(scoreInterval);
        winnersCount++;
        winnersCountSpan.textContent = winnersCount;
        winModal.style.display = 'flex';
    }

    // Обработчики событий
    playButton.addEventListener('click', () => {
        mainMenu.style.display = 'none';
        gameContainer.style.display = 'flex';
        initGame();
    });

    settingsButton.addEventListener('click', () => {
        settingsModal.style.display = 'flex';
    });

    exitButton.addEventListener('click', () => {
        if (confirm(isEnglish ? 'Are you sure you want to exit?' : 'Вы уверены, что хотите выйти?')) {
            window.close();
        }
    });

    closeSettings.addEventListener('click', () => {
        settingsModal.style.display = 'none';
    });

    restartButton.addEventListener('click', () => {
        gameOverModal.style.display = 'none';
        initGame();
    });

    homeButton.addEventListener('click', () => {
        gameOverModal.style.display = 'none';
        gameContainer.style.display = 'none';
        mainMenu.style.display = 'block';
        clearInterval(gameInterval);
        clearInterval(scoreInterval);
    });

    winHomeButton.addEventListener('click', () => {
        winModal.style.display = 'none';
        gameContainer.style.display = 'none';
        mainMenu.style.display = 'block';
        clearInterval(gameInterval);
        clearInterval(scoreInterval);
    });

    telegramIcon.addEventListener('click', () => {
        window.open('http://t.me/yhcomapny', '_blank');
    });
    helpButton.addEventListener('click', () => {
        helpModal.style.display = helpModal.style.display === 'block' ? 'none' : 'block';
    });

    // Переключение темы
    themeSwitch.addEventListener('change', () => {
        isDarkTheme = themeSwitch.checked;
        document.body.classList.toggle('dark-theme', isDarkTheme);
        
        // Сохранение темы в localStorage
        localStorage.setItem('snakeTheme', isDarkTheme ? 'dark' : 'light');
    });

    // Переключение языка
    languageSwitch.addEventListener('change', () => {
        isEnglish = languageSwitch.checked;
        updateTexts();
        
        // Сохранение языка в localStorage
        localStorage.setItem('snakeLanguage', isEnglish ? 'en' : 'ru');
    });

    // Обновление текстов при смене языка
    function updateTexts() {
        if (isEnglish) {
            // Перевод на английский
            playButton.innerHTML = '<i class="fas fa-play"></i> Play';
            settingsButton.innerHTML = '<i class="fas fa-cog"></i> Settings';
            exitButton.innerHTML = '<i class="fas fa-sign-out-alt"></i> Exit';
            document.querySelector('.modal-content h2').textContent = 'Settings';
            document.querySelectorAll('.switch-container span')[0].textContent = 'Language';
            document.querySelectorAll('.switch-container span')[1].textContent = 'Theme';
            document.getElementById('game-over-modal').querySelector('h2').textContent = 'Game Over';
            restartButton.innerHTML = '<i class="fas fa-redo"></i> Restart';
            homeButton.innerHTML = '<i class="fas fa-home"></i> Main Menu';
            helpModal.innerHTML = 'If you encounter an error, contact us by email:<br><a href="mailto:wertq6306@gmail.com">wertq6306@gmail.com</a>';
        } else {
            // Перевод на русский
            playButton.innerHTML = '<i class="fas fa-play"></i> Играть';
            settingsButton.innerHTML = '<i class="fas fa-cog"></i> Настройки';
            exitButton.innerHTML = '<i class="fas fa-sign-out-alt"></i> Выход';
            document.querySelector('.modal-content h2').textContent = 'Настройки';
            document.querySelectorAll('.switch-container span')[0].textContent = 'Язык';
            document.querySelectorAll('.switch-container span')[1].textContent = 'Тема';
            document.getElementById('game-over-modal').querySelector('h2').textContent = 'Игра окончена';
            restartButton.innerHTML = '<i class="fas fa-redo"></i> Заново';
            homeButton.innerHTML = '<i class="fas fa-home"></i> Главное меню';
            helpModal.innerHTML = 'Если у вас возникла какая-то ошибка, обратитесь к нам по почте:<br><a href="mailto:wertq6306@gmail.com">wertq6306@gmail.com</a>';
        }
        updateScoreDisplay();
    }

    // Управление с клавиатуры
    document.addEventListener('keydown', (e) => {
        if (!gameStarted && (e.key === 'ArrowUp' || e.key === 'ArrowDown' || e.key === 'ArrowLeft' || e.key === 'ArrowRight' || 
                            e.key === 'w' || e.key === 'a' || e.key === 's' || e.key === 'd')) {
            gameStarted = true;
        }
        
        if (!canChangeDirection) return;
        
        switch (e.key) {
            case 'ArrowUp':
            case 'w':
                if (direction !== 'down') {
                    nextDirection = 'up';
                    canChangeDirection = false;
                }
                break;
            case 'ArrowDown':
            case 's':
                if (direction !== 'up') {
                    nextDirection = 'down';
                    canChangeDirection = false;
                }
                break;
            case 'ArrowLeft':
            case 'a':
                if (direction !== 'right') {
                    nextDirection = 'left';
                    canChangeDirection = false;
                }
                break;
            case 'ArrowRight':
            case 'd':
                if (direction !== 'left') {
                    nextDirection = 'right';
                    canChangeDirection = false;
                }
                break;
        }
    });
    
    // Мобильное управление
    upBtn.addEventListener('click', () => {
        if (!gameStarted) gameStarted = true;
        if (direction !== 'down') nextDirection = 'up';
    });

    downBtn.addEventListener('click', () => {
        if (!gameStarted) gameStarted = true;
        if (direction !== 'up') nextDirection = 'down';
    });

    leftBtn.addEventListener('click', () => {
        if (!gameStarted) gameStarted = true;
        if (direction !== 'right') nextDirection = 'left';
    });

    rightBtn.addEventListener('click', () => {
        if (!gameStarted) gameStarted = true;
        if (direction !== 'left') nextDirection = 'right';
    });

    // Загрузка сохраненных настроек
    function loadSettings() {
        const savedTheme = localStorage.getItem('snakeTheme');
        const savedLanguage = localStorage.getItem('snakeLanguage');
        
        if (savedTheme === 'dark') {
            isDarkTheme = true;
            document.body.classList.add('dark-theme');
            themeSwitch.checked = true;
        }
        
        if (savedLanguage === 'en') {
            isEnglish = true;
            languageSwitch.checked = true;
            updateTexts();
        }
    }

    // Инициализация при загрузке страницы
    window.addEventListener('load', () => {
        loadSettings();
        
        // Скрытие всех модальных окон
        settingsModal.style.display = 'none';
        gameOverModal.style.display = 'none';
        winModal.style.display = 'none';
        helpModal.style.display = 'none';
        
        // Скрытие игрового контейнера
        gameContainer.style.display = 'none';
    });
</script>
